# NapCat4J 架构设计文档

本文件描述 NapCat4J 框架的整体架构、模块分层、数据流、事件流和设计原则。
目标是提供清晰的指导，确保框架可扩展、可维护并可长期演进。

---

## 1. 总体架构

NapCat4J 采用 **分层模块化架构**，核心理念：

```
+-----------------------------------------------------+
| napcat4j-framework
|  - 高层客户端接口
|  - 事件分发 / Listener 注册
|  - API 封装
+-----------------------------------------------------+
               ↓ 依赖
+-----------------------------------------------------+
| napcat4j-cache
|  - 本地状态缓存（用户 / 群 / 消息）
|  - 缓存接口 / CacheProvider
+-----------------------------------------------------+
               ↓ 依赖
+-----------------------------------------------------+
| napcat4j-core
|  - 协议层（OneBot / NapCat / go-cqhttp）
|  - WebSocket / HTTP 客户端
|  - 底层消息发送与接收
+-----------------------------------------------------+
               ↓ 依赖
+-----------------------------------------------------+
| napcat4j-model
|  - 数据模型（User / Group / Message / Event）
|  - POJO / record 对象
+-----------------------------------------------------+
```

---

## 2. 模块职责概述

### 2.1 Model 模块

* 所有业务对象定义
* 事件对象定义
* 独立于网络和缓存

### 2.2 Core 模块

* WebSocket / HTTP 通信
* 协议封装
* 底层 API 调用
* 异步消息收发

### 2.3 Cache 模块

* 状态缓存（群信息、用户信息、成员列表）
* 可配置缓存策略（TTL / LRU / Lazy Load）
* 提供接口供 Framework 调用

### 2.4 Framework 模块

* 高层客户端入口
* 事件系统（Listener / Annotation / Lambda）
* API 封装（发送消息、管理群成员等）
* 生命周期管理（登录、重连、关闭）

---

## 3.数据流

典型消息流：

```
NapCatQQ Server
       │
       ▼
   WebSocket / HTTP
       │
       ▼
   napcat4j-core
       │
       ▼
   Event Object (model)
       │
       ▼
   napcat4j-cache
       │
       ▼
   napcat4j-framework
       │
       ▼
   用户业务代码 / Listener
```

> 所有跨模块操作通过 **事件对象和接口**，禁止直接操作下层数据结构。

---

## 4. 事件流设计

1. **接收事件**

    * Core 接收到原始 JSON → 转换为 Model 中的事件对象
2. **缓存更新**

    * Cache 模块根据事件更新状态
3. **事件分发**

    * Framework 模块通过 EventBus 或 Listener 调用业务回调
4. **异常处理**

    * 异常捕获 → 日志记录 → 可选通知业务层

---

## 5. API 设计原则

* **高层 API 简洁**
  业务开发者无需关心 WebSocket / HTTP 细节
* **强类型**
  尽量使用 `record` 或不可变对象
* **模块边界清晰**
  Framework → Cache → Core → Model

---

## 6. 扩展性与插件化

* Cache 提供接口 `CacheProvider`，允许用户实现自定义缓存
* Event 系统支持自定义 Listener / 注解方式
* 未来可以增加 Plugin 模块，实现指令、管理、统计等扩展

---

## 7. 生命周期管理

* **客户端启动**

    * 初始化 Core、Cache
    * 登录 NapCat 服务
* **事件循环**

    * Core 处理消息 → Cache 更新 → Framework 分发事件
* **客户端关闭**

    * 关闭 WebSocket / HTTP
    * 清理缓存
    * 卸载 Listener

---

## 8. 异常与错误策略

* Core 捕获网络异常 → Framework 层封装为统一异常类型
* 事件分发时，异常不会中断整个事件循环
* Cache 操作异常可回退到默认策略，不影响 Framework 事件处理

---

## 9. 图示示意

```
       +---------------------+
       | NapCatQQ / Server   |
       +---------------------+
                 │
                 ▼
       +---------------------+
       |      Core Module    |
       +---------------------+
                 │
                 ▼
       +---------------------+
       |      Model Module   |
       +---------------------+
                 │
                 ▼
       +---------------------+
       |      Cache Module   |
       +---------------------+
                 │
                 ▼
       +---------------------+
       |   Framework Module  |
       +---------------------+
                 │
                 ▼
       +---------------------+
       |   用户业务代码 / Bot |
       +---------------------+
```

---

## 10. 总结

NapCat4J 架构特点：

* **分层清晰**：Model → Core → Cache → Framework
* **事件驱动**：消息接收 → 缓存更新 → 事件分发
* **模块化设计**：每层可独立测试、替换
* **高扩展性**：缓存、事件、插件接口可自定义
* **高可维护性**：模块边界明确，异常与生命周期管理规范